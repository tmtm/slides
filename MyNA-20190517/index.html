<!doctype html>
<html lang="en">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    <meta charset="utf-8">

<title>MySQLと令和</title>

<meta name="description" content="">
<meta name="author" content="">
<meta name="generator" content="reveal-ck 3.9.1">



<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

<link rel="stylesheet" href="css/reveal.css">
<link rel="stylesheet" href="css/theme/tmtms.css" id="theme">

<!-- Code syntax highlighting -->
<link rel="stylesheet" href="lib/css/zenburn.css">

<link rel="stylesheet" href="css/reveal-ck.css">

<link rel="stylesheet" href="css/rabbit.css">
<link rel="stylesheet" href="css/theme/tmtms.css">

<!-- Printing and PDF exports -->
<script>
  var link = document.createElement( 'link' );
  link.rel = 'stylesheet';
  link.type = 'text/css';
  link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
  document.getElementsByTagName( 'head' )[0].appendChild( link );
</script>

<!--[if lt IE 9]>
<script src="lib/js/html5shiv.js"></script>
<![endif]-->

  </head>

  <body>
    <div class="reveal">
  <!-- Any section element inside of this container is displayed as a slide -->
  <div class="slides">
    <section>

<h1>MySQLと令和</h1>

<p>とみたまさひろ</p>

<p>2019-05-17</p>

<p>Oracle Code Tokyo 2019</p>

</section>
<section>

<h2>自己紹介</h2>

<p><img src="images/icon2.jpg" alt="" style="position:absolute;top:25%;right:0;width:180px;border:0px"></p>

<ul>
  <li>とみたまさひろ</li>
  <li><a href="https://twitter.com/tmtms">@tmtms</a></li>
  <li>日本MySQLユーザ会</li>
  <li>富士通クラウドテクノロジーズ</li>
  <li>Oracle ACE Associate</li>
  <li><a href="https://tmtm.github.io/mysql-params/?vers=8.0.11,8.0.16&amp;diff=true">http://tmtm.github.io/mysql-params/</a></li>
  <li>得意技: Ruby, 文字化け</li>
</ul>

</section>
<section>

<h1>㊗令和元年🎉</h1>

</section>
<section>

<h2>今日は「令和」の話をします</h2>

</section>
<section>

<h2>その1</h2>

<h2>「令和」と言えば…</h2>

</section>
<section>

<h2>似てるけど違う文字</h2>

<h2>「令」と「令」</h2>

</section>
<section>

<h3>同じに見えるけど別の文字</h3>

<ul>
  <li>「令」 U+4EE4 CJK UNIFIED IDEOGRAPH</li>
  <li>「令」 U+F9A8 CJK COMPATIBILITY IDEOGRAPH</li>
</ul>

<p>困る！</p>

</section>
<section>

<h3>MySQLで</h3>

<pre style="font-size: 60%"><code class="language-sql">mysql&gt; set @a='令和', @b='令和';
mysql&gt; select @a, @b, hex(@a), hex(@b);
+--------+--------+--------------+--------------+
| @a     | @b     | hex(@a)      | hex(@b)      |
+--------+--------+--------------+--------------+
| 令和   | 令和   | E4BBA4E5928C | EFA6A8E5928C |
+--------+--------+--------------+--------------+
mysql&gt; select @a=@b;
+-------+
| @a=@b |
+-------+
|     1 | ← 一致
+-------+
</code></pre>

</section>
<section>

<h1>😊</h1>

</section>
<section>

<h2>その2</h2>
<h2>「令和」と言えば…</h2>

</section>
<section>

<h2>異体字</h2>

<h2>「<span style="font-family:IPAmjMincho">令󠄁</span>」と「<span style="font-family:IPAmjMincho">令󠄂</span>」</h2>

</section>
<section>

<h3>違う字形だけど同じ文字</h3>

<p>異体字セレクタ</p>

<ul>
  <li>「<span style="font-family:IPAmjMincho">令</span>」 U+4EE4</li>
  <li>「<span style="font-family:IPAmjMincho">令󠄁</span>」 U+4EE4 <strong>U+E0101</strong>
</li>
  <li>「<span style="font-family:IPAmjMincho">令󠄂</span>」 U+4EE4 <strong>U+E0102</strong>
</li>
</ul>

<p>困る！</p>

</section>
<section>

<h3>MySQLで</h3>

<pre style="font-size: 60%"><code class="language-sql">mysql&gt; set @a='令和', @b='令󠄁和', @c='令󠄂和';
mysql&gt; select hex(@a), hex(@b), hex(@c)\G
*************************** 1. row ***************************
hex(@a): E4BBA4E5928C
hex(@b): E4BBA4F3A08481E5928C
hex(@c): E4BBA4F3A08482E5928C
mysql&gt; select @a=@b, @b=@c;
+-------+-------+
| @a=@b | @b=@c |
+-------+-------+
|     1 |     1 | ← 一致
+-------+-------+
</code></pre>

<p style="font-size:60%; color:#888">※都合により同じ字体に見えてます</p>

</section>
<section>

<h1>😊</h1>

</section>
<section>

<h2>その3</h2>
<h2>「令和」と言えば…</h2>

</section>
<section>

<h2>元号</h2>

</section>
<section>

<h2>元号と言えば…</h2>

</section>
<section>

<h2>合字</h2>

<ul style="font-family:IPAexGothic">
  <li>明治: ㍾ U+337E</li>
  <li>大正: ㍽ U+337D</li>
  <li>昭和: ㍼ U+337C</li>
  <li>平成: ㍻ U+337B</li>
  <li>令和: ㋿ U+32FF</li>
</ul>

</section>
<section>

<h3>MySQLで</h3>

<pre style="font-size: 60%"><code class="language-sql">mysql&gt; select '明治'='㍾', '大正'='㍽', '昭和'='㍼',
    -&gt; '平成'='㍻', '令和'='㋿'\G
*************************** 1. row ***************************
'明治'='㍾': 1   ← 一致
'大正'='㍽': 1   ← 一致
'昭和'='㍼': 1   ← 一致
'平成'='㍻': 1   ← 一致
'令和'='㋿': 0   ← 不一致
</code></pre>

</section>
<section>

<h1>😇</h1>

</section>
<section>

<h2>本日のテーマ</h2>

</section>
<section>

<h2>「ここがヘンだよMySQL」</h2>

</section>
<section>

<h2>なにが起きてるのか？</h2>

</section>
<section>

<h2>Unicodeの照合順序</h2>

<p>Unicode Collation Algorithm (UCA)<br>
<a href="https://unicode.org/reports/tr10/tr10-34.html" style="font-size:80%">https://unicode.org/reports/tr10/tr10-34.html</a></p>

<p>Default Unicode Collation Element Table (DUCET)<br>
<a href="https://www.unicode.org/Public/UCA/9.0.0/allkeys.txt" style="font-size:80%">https://www.unicode.org/Public/UCA/9.0.0/allkeys.txt</a></p>

<p>文字毎にWeightという値が定義されている<br>
Weightが等しいなら等しい文字</p>

</section>
<section>

<h2>その1</h2>

<h2>似てるけど違う文字</h2>

<h2>「令」と「令」</h2>

</section>
<section>

<ul>
  <li>「令」 U+4EE4 CJK UNIFIED IDEOGRAPH<br>
DUCETには無いけど計算で求まる
    <pre><code>[.FB40.0020.0002][.(CP | 0x8000).0000.0000]
→ [.FB40.0020.0002][.CEE4.0000.0000]
</code></pre>
  </li>
  <li>「令」 U+F9A8 CJK COMPATIBILITY IDEOGRAPH<br>
DUCETにある
    <pre><code>F9A8  ; [.FB40.0020.0002][.CEE4.0000.0000]
</code></pre>
  </li>
</ul>

<p>Weightが一致するから等しい</p>

</section>
<section>

<h2>その2</h2>

<h2>異体字</h2>

<h2>「<span style="font-family:IPAmjMincho">令󠄁</span>」と「<span style="font-family:IPAmjMincho">令󠄂</span>」</h2>

</section>
<section>

<p>異体字セレクタ</p>

<ul>
  <li>「<span style="font-family:IPAmjMincho">令</span>」 U+4EE4</li>
  <li>「<span style="font-family:IPAmjMincho">令󠄁</span>」 U+4EE4 <strong>U+E0101</strong>
</li>
  <li>「<span style="font-family:IPAmjMincho">令󠄂</span>」 U+4EE4 <strong>U+E0102</strong>
</li>
</ul>

<p>異体字セレクタはDUCETにある</p>

<pre><code>E0101 ; [.0000.0000.0000] # VARIATION SELECTOR-18
E0102 ; [.0000.0000.0000] # VARIATION SELECTOR-19
</code></pre>

<p>UCAではすべてゼロの文字は無視</p>

</section>
<section>

<h2>その3</h2>

<h2>合字</h2>

<p style="font-family:IPAexGothic">㍾ / ㍽ / ㍼ / ㍻ / ㋿</p>

</section>
<section>

<h3>平成=㍻</h3>

<ul>
  <li>平(U+5E73)成(U+6210): ㍻(U+337B)</li>
</ul>

<pre style="font-size: 60%"><code>平成 [.FB40.0020.0002][.DE73.0000.0000][.FB40.0020.0002][.E210.0000.0000]
㍻   [.FB40.0020.001C][.DE73.0000.0000][.FB40.0020.001C][.E210.0000.0000]
</code></pre>

<p>ちょっと違う… 🤔</p>

</section>
<section>

<h3>utf8mb4_0900_ai_ci</h3>

<p>MySQLのデフォルトのCollation</p>

<table>
  <thead>
    <tr>
      <th>要素</th>
      <th>意味</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>utf8mb4</td>
      <td>4バイトUTF-8</td>
    </tr>
    <tr>
      <td>0900</td>
      <td>Unicode 9.0.0</td>
    </tr>
    <tr>
      <td>ai</td>
      <td>アクセントの違いを無視</td>
    </tr>
    <tr>
      <td>ci</td>
      <td>大文字小文字の違いを無視</td>
    </tr>
  </tbody>
</table>

<p><code>ci</code>の場合はWeightの3番目を無視</p>

</section>
<section>

<p><code>ci</code>の場合はWeightの3番目を無視</p>

<pre style="font-size: 60%"><code>平成 [.FB40.0020.0002][.DE73.0000.0000][.FB40.0020.0002][.E210.0000.0000]
㍻   [.FB40.0020.001C][.DE73.0000.0000][.FB40.0020.001C][.E210.0000.0000]
</code></pre>

<p>3番目を無視すると</p>

<pre style="font-size: 60%"><code>平成 [.FB40.0020.    ][.DE73.0000.    ][.FB40.0020.    ][.E210.0000.    ]
㍻   [.FB40.0020.    ][.DE73.0000.    ][.FB40.0020.    ][.E210.0000.    ]
</code></pre>

<p>一致</p>

</section>
<section>

<h3 style="font-family:IPAexGothic">令和≠㋿</h3>

<p style="font-family:IPAexGothic">「㋿」がDUCETに無い！</p>

</section>
<section>

<p style="font-family:IPAexGothic">「㋿」はUnicode 9.0.0 に無い！</p>

</section>
<section>

<p style="font-family:IPAexGothic">「㋿」はUnicode 12.1.0 で追加</p>

<p><a href="http://unicode.org/versions/Unicode12.1.0/" style="font-size:80%">http://unicode.org/versions/Unicode12.1.0/</a></p>

<p style="font-family:IPAexGothic">12.1 は「㋿」のためだけに 5/7 にリリース</p>

<blockquote style="font-size: 50%; text-align: left">
  <p>Unicode 12.1 adds exactly one character, for a total of 137,929 characters.<br>
The new character added to Version 12.1 is:<br>
    U+32FF SQUARE ERA NAME REIWA<br>
Version 12.1 adds that single character to enable software to be<br>
rapidly updated to support the new Japanese era name in calendrical<br>
systems and date formatting. The new Japanese era name was officially<br>
announced on April 1, 2019, and is effective as of May 1, 2019.</p>
</blockquote>

</section>
<section>

<h2>MySQL独自の変な挙動じゃなくてUnicodeの規則だった！</h2>

</section>
<section>

<h2>Unicode規則にちゃんと従ってるMySQLえらい！</h2>

</section>
<section>

<h2>本日のテーマ</h2>

</section>
<section>

<h2>「ここがスゴイよMySQL」</h2>

</section>

  </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>


<script>
  (function() {
  function extend( a, b ) {
    for(var i in b) {
      a[i] = b[i];
    }
  }
  var baseOptions = {
    transition: 'default',

    dependencies: [
      { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'plugin/zoom-js/zoom.js', async: true },
      { src: 'plugin/notes/notes.js', async: true }
    ]
  };

  
    baseOptions.dependencies.push({ src: 'plugin/rabbit/rabbit.js', async: true });
  

  var configOptions = {"controls":true,"postgress":true,"slideNumber":true,"history":true,"overview":true,"enter":true,"touch":false,"loop":false,"rtl":false,"fragments":true,"autoSlide":0,"autoSlideStoppable":false,"mouseWheel":false,"transition":"default","transitionSpeed":"fast","alloted_time":420}
  var initializeOptions = {};
  extend(initializeOptions, baseOptions);
  extend(initializeOptions, configOptions);
  Reveal.initialize(initializeOptions);
})();

</script>

  </body>
</html>
